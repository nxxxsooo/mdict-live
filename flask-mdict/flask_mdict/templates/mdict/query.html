{% extends "layout.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{url_for('.static', filename='css/typeahead.css')}}">
<link rel="stylesheet" href="{{url_for('.static', filename='css/mdict.css')}}">
{% endblock %}

{% block subtitle %}{{word}} - {{config.APP_NAME}}{% endblock %}

{# Sidebar: Dictionary List & History #}
{% block sidebar %}
    <h6 class="menu-title">从以下词典查找 (Dictionaries)</h6>
    {% for uuid, item in contents.items() %}
    <li>
        <div class="form-control p-0 items-start">
            <label class="label cursor-pointer justify-start gap-2 w-full">
                <input type="checkbox" name="mdict_enable" value="{{uuid}}" class="checkbox checkbox-xs" {{'checked' if item.enable}}/>
                <span class="label-text truncate max-w-[180px] text-xs" title="{{item.title|safe}}">{{item.title|safe}}</span>
            </label>
        </div>
    </li>
    {% endfor %}

    <div class="divider"></div>
    <div class="flex justify-between items-center px-4">
        <h6 class="menu-title p-0">历史 (History)</h6>
        <a href="{{url_for('.export_history')}}" class="link link-primary text-xs">导出</a>
    </div>
    {%for row in history%}
    <li>
        <a href="{{url_for('.query_word_all', word=row.word)}}" class="flex justify-between">
            {{row.word}}
            <span class="badge badge-sm">{{row.count}}</span>
        </a>
    </li>
    {%endfor%}
{% endblock %}

{# Navigation / Search Bar #}
{% block navmenu %}
    <form method="POST" action="{{url_for('.query_word_all')}}" class="mb-6">
        <div class="join w-full">
            <div class="flex-1">
                 {{ form.word(placeholder='Search word...', class='input input-bordered join-item w-full', autocomplete='off') }}
            </div>
            <button id="btn-search" type="submit" class="btn btn-primary join-item">
                <i class="fas fa-search"></i> Search
            </button>
        </div>
        {{ form.csrf_token }}
    </form>
{% endblock %}

{# Main Content: Definitions #}
{% block maincontent %}
    <!-- Message Modal (Using DaisyUI) -->
    <dialog id="message_modal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Message</h3>
        <p class="py-4">{{message}}</p>
        <div class="modal-action">
          <form method="dialog">
            <button class="btn">Close</button>
          </form>
        </div>
      </div>
    </dialog>

    <div class="flex flex-col gap-6">
        {% for uuid, item in contents.items() if item.content %}
            <div id="{{uuid}}" class="target:pt-20"> <!-- Anchor fix -->
                <div class="card bg-base-100 shadow-lg border border-base-200">
                    <div class="card-body p-4" id="class_{{uuid}}">
                        <div class="flex justify-between items-center mb-2 border-b pb-2">
                             <h2 class="card-title text-lg">
                                <img class="rounded w-5 h-5" src="{{url_for('.query_resource', uuid=uuid, resource=item.logo)}}"/>
                                <span class="truncate">{{item.title|safe}}</span>
                            </h2>
                            <div class="flex gap-2 text-sm">
                                {%if item.content%}<span class="badge badge-ghost">{{word_meta|safe}}</span>{%endif%}
                                <a href="{{url_for('.query_word', uuid=uuid, word=word)}}" target="_blank" class="btn btn-ghost btn-xs" title="Open in new tab">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            </div>
                        </div>
                        
                        <div class="mdict overflow-x-auto">
                            <!-- Mdict Content -->
                            {{item.content|safe}}
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
             <div class="hero bg-base-200 rounded-box p-10">
                <div class="hero-content text-center">
                    <div class="max-w-md">
                    <h1 class="text-3xl font-bold">Search for a word</h1>
                    <p class="py-6">Select dictionaries from the sidebar and type a word above to begin.</p>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}
{% block script %}
{{super()}}
<script src="{{url_for(".static", filename="js/mdict.js")}}"></script>
<script src="{{url_for(".static", filename="js/typeahead.bundle.min.js")}}"></script>
<script type="text/javascript">
    if ("{{message}}") {
        document.getElementById('message_modal').showModal();
    }
/* typeahead */
var dataset_engine = new Bloodhound({
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    datumTokenizer: Bloodhound.tokenizers.whitespace,
    remote: {
        url: '{{url_for('.query_part', part='')}}' + '%QUERY',
        wildcard: '%QUERY',
        transform: function(data){
            return data.suggestion;
        }
    }
});
$('#word').typeahead({
    minLength: 2,
    highlight: true
},
{
    name: 'suggestion',
    limit: 10,
    source: dataset_engine,
    display: function(data) {
        return data;
    }
});
/* dictionary checkbox */
let toggle_url="{{url_for('.mdict_toggle', uuid='')}}";
$('input[name="mdict_enable"]').each((index, element) => {
    element.addEventListener('change', (event) => {
        let url = toggle_url + element.value;
        $.getJSON(url, (data) => {
            // console.log(data);
        });
    });
});

    $('#online_dict').find('a').each(function(index, element) {
        element.href += '{{word}}';
    });
</script>
{% endblock %}
